<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANPURNA CANTEEN ðŸ˜Š</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for vector icons -->
    <script src="https://unpkg.com/lucide@latest/dist/lucide.js"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-800 p-4 flex flex-col items-center">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script type="module">
        // --- Global Variables and Local Storage Functions ---
        let cart = [];
        let total = 0;
        let transactions = [];
        let currentOrderId = '';

        // Mock food items
        const foodItems = [
            { id: 1, name: 'Thali', price: 50, image: 'https://placehold.co/150x150/f0f0f0/333?text=Thali' },
            { id: 2, name: 'Special Thali', price: 100, image: 'https://placehold.co/150x150/f0f0f0/333?text=Special' },
            { id: 3, name: 'Dal', price: 50, image: 'https://placehold.co/150x150/f0f0f0/333?text=Dal' },
            { id: 4, name: 'Samosa', price: 10, image: 'https://placehold.co/150x150/f0f0f0/333?text=Samosa' },
            { id: 5, name: 'Chai', price: 10, image: 'https://placehold.co/150x150/f0f0f0/333?text=Chai' },
            { id: 6, name: 'Coffee', price: 15, image: 'https://placehold.co/150x150/f0f0f0/333?text=Coffee' },
            { id: 7, name: 'Vada Pav', price: 20, image: 'https://placehold.co/150x150/f0f0f0/333?text=Vada+Pav' },
            { id: 8, name: 'Pakora', price: 30, image: 'https://placehold.co/150x150/f0f0f0/333?text=Pakora' },
            { id: 9, name: 'Sandwich', price: 40, image: 'https://placehold.co/150x150/f0f0f0/333?text=Sandwich' },
            { id: 10, name: 'Veg Biryani', price: 80, image: 'https://placehold.co/150x150/f0f0f0/333?text=Biryani' },
            { id: 11, name: 'Rajma Chawal', price: 70, image: 'https://placehold.co/150x150/f0f0f0/333?text=Rajma' },
            { id: 12, name: 'Aloo Paratha', price: 35, image: 'https://placehold.co/150x150/f0f0f0/333?text=Paratha' },
            { id: 13, name: 'Puri Sabzi', price: 45, image: 'https://placehold.co/150x150/f0f0f0/333?text=Puri' },
            { id: 14, name: 'Lassi', price: 25, image: 'https://placehold.co/150x150/f0f0f0/333?text=Lassi' },
            { id: 15, name: 'Juice', price: 20, image: 'https://placehold.co/150x150/f0f0f0/333?text=Juice' },
        ];

        // Function to load transactions from local storage
        const loadTransactions = () => {
            const storedTransactions = localStorage.getItem('canteenTransactions');
            if (storedTransactions) {
                try {
                    transactions = JSON.parse(storedTransactions);
                } catch (e) {
                    console.error("Error parsing transactions from local storage:", e);
                    transactions = [];
                }
            }
        };

        // Function to save transactions to local storage
        const saveTransactions = () => {
            localStorage.setItem('canteenTransactions', JSON.stringify(transactions));
        };
        
        // Function to start a new order, resetting the cart and generating a new order ID
        const startNewOrder = () => {
            cart = [];
            total = 0;
            currentOrderId = crypto.randomUUID().substring(0, 8); // Generate a new short order ID
            renderCart();
            document.getElementById('current-order-id').textContent = currentOrderId;
            showMessage('Ready for a new order.', 'info');
        };

        // Renders the food item cards
        const renderFoodItems = () => {
            const foodItemsContainer = document.getElementById('food-items-container');
            foodItemsContainer.innerHTML = '';
            foodItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'bg-white p-4 rounded-xl shadow-md transform transition duration-300 hover:scale-105 cursor-pointer flex flex-col items-center text-center relative';
                itemCard.dataset.itemId = item.id;
                itemCard.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-cover rounded-full mb-3 shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/150x150/f0f0f0/333?text=${item.name.replace(/\s/g, '+')}'" />
                    <h3 class="text-xl font-bold">${item.name}</h3>
                    <p class="text-sm text-gray-600">â‚¹${item.price}</p>
                    <div id="quantity-${item.id}" class="absolute top-2 right-2 bg-indigo-500 text-white rounded-full h-8 w-8 flex items-center justify-center font-bold text-lg shadow-lg hidden"></div>
                `;
                foodItemsContainer.appendChild(itemCard);
            });
        };

        // Renders the cart summary
        const renderCart = () => {
            const cartItemsContainer = document.getElementById('cart-items-container');
            const totalAmountSpan = document.getElementById('total-amount');
            const cartEmptyMessage = document.getElementById('cart-empty-message');
            const cashButton = document.getElementById('cash-button');
            const onlineButton = document.getElementById('online-button');

            cartItemsContainer.innerHTML = '';
            
            if (cart.length > 0) {
                cartEmptyMessage.classList.add('hidden');
                cart.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center text-lg';
                    listItem.innerHTML = `
                        <span class="flex-1">${item.name} (x${item.quantity})</span>
                        <span class="font-semibold">â‚¹${item.price * item.quantity}</span>
                        <div class="ml-4 flex gap-2">
                            <button data-action="add" data-id="${item.id}" class="text-white bg-indigo-500 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shadow-sm hover:bg-indigo-600 transition-colors">+</button>
                            <button data-action="remove" data-id="${item.id}" class="text-white bg-red-500 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold shadow-sm hover:bg-red-600 transition-colors">-</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(listItem);
                });
                totalAmountSpan.textContent = `â‚¹${total}`;
                cashButton.disabled = false;
                onlineButton.disabled = false;
            } else {
                cartEmptyMessage.classList.add('hidden');
                totalAmountSpan.textContent = `â‚¹0`;
                cashButton.disabled = true;
                onlineButton.disabled = true;
            }
            
            // Update quantity display on food cards
            foodItems.forEach(item => {
                const quantityElement = document.getElementById(`quantity-${item.id}`);
                const cartItem = cart.find(i => i.id === item.id);
                if (cartItem) {
                    quantityElement.textContent = cartItem.quantity;
                    quantityElement.classList.remove('hidden');
                } else {
                    quantityElement.classList.add('hidden');
                }
            });
            updateLucideIcons(); // Ensure icons are re-rendered
        };

        // Function to update the total amount
        const calculateTotal = () => {
            total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        };

        // Handles adding an item to the cart
        const handleAddToCart = (itemId) => {
            const item = foodItems.find(i => i.id === parseInt(itemId));
            if (!item) return;
            
            const existingItemIndex = cart.findIndex((i) => i.id === item.id);
            if (existingItemIndex !== -1) {
                cart[existingItemIndex].quantity += 1;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            calculateTotal();
            renderCart();
            showMessage('', 'remove'); // Clear any messages
        };

        // Handles removing an item from the cart
        const handleRemoveFromCart = (itemId) => {
            const existingItemIndex = cart.findIndex((i) => i.id === parseInt(itemId));
            if (existingItemIndex !== -1) {
                if (cart[existingItemIndex].quantity > 1) {
                    cart[existingItemIndex].quantity -= 1;
                } else {
                    cart.splice(existingItemIndex, 1);
                }
                calculateTotal();
                renderCart();
                showMessage('', 'remove'); // Clear any messages
            }
        };

        // Handles payment method selection
        const handlePayment = (method) => {
            if (total === 0) {
                showMessage('Please add items to your cart first.', 'info');
                return;
            }
            if (method === 'online') {
                showQrModal();
            } else {
                recordTransaction('Cash');
            }
        };

        // Show a message in the message box
        const showMessage = (text, type) => {
            const messageBox = document.getElementById('message-box');
            if (type === 'remove') {
                messageBox.innerHTML = '';
                return;
            }
            const bgColor = type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700';
            messageBox.innerHTML = `<div class="mt-4 text-center p-3 rounded-lg ${bgColor}">${text}</div>`;
        };

        // Show the QR code modal
        const showQrModal = () => {
            document.getElementById('qr-modal').classList.remove('hidden');
            document.getElementById('qr-total-amount').textContent = `â‚¹${total}`;
            document.getElementById('qr-success-message').classList.add('hidden');
            document.getElementById('qr-payment-buttons').classList.remove('hidden');
            document.getElementById('qr-image-container').classList.remove('hidden');
        };

        // Close the QR code modal
        const closeQrModal = () => {
            document.getElementById('qr-modal').classList.add('hidden');
        };

        // Simulate a successful online payment
        const simulateOnlinePayment = () => {
            document.getElementById('qr-image-container').classList.add('hidden');
            document.getElementById('qr-payment-buttons').classList.add('hidden');
            document.getElementById('qr-success-message').classList.remove('hidden');
            showMessage('Payment Successful! Recording transaction...', 'info');
            setTimeout(() => {
                recordTransaction('Online');
                closeQrModal();
            }, 1500); // Simulate processing time
        };

        // Finalize and record the transaction to local storage
        const recordTransaction = (paymentType) => {
            if (cart.length === 0) {
                showMessage('Error: Cannot complete an empty transaction.', 'error');
                return;
            }

            const transaction = {
                id: crypto.randomUUID(), // Unique ID for the transaction
                date: new Date().toISOString().split('T')[0],
                orderId: currentOrderId,
                items: cart,
                totalAmount: total,
                paymentType: paymentType,
                timestamp: Date.now(),
            };

            transactions.push(transaction);
            saveTransactions();
                
            // Reset for the next order
            startNewOrder();
            showMessage(`Transaction completed successfully via ${paymentType}.`, 'info');
        };

        // Generates and downloads an Excel file of all transactions
        const handleDownloadReport = () => {
            if (transactions.length === 0) {
                showMessage('No transactions to download.', 'info');
                return;
            }
        
            // Prepare a flat array of data for the Excel sheet
            const reportData = [];
            transactions.forEach(transaction => {
                transaction.items.forEach(item => {
                    reportData.push({
                        'Date': transaction.date,
                        'Order ID': transaction.orderId,
                        'Payment Type': transaction.paymentType,
                        'Item Name': item.name,
                        'Item Price': item.price,
                        'Quantity': item.quantity,
                        'Total for Item': item.price * item.quantity,
                        'Transaction Total': transaction.totalAmount,
                        'Transaction Timestamp': new Date(transaction.timestamp).toLocaleString()
                    });
                });
            });

            // Create a worksheet from the flat data
            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Canteen Report");
        
            // Download the file
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `canteen_report_${today}.xlsx`);
        };
        
        // Initial setup on window load
        window.onload = () => {
            loadTransactions();
            renderFoodItems();
            renderCart();
            startNewOrder(); // Start the first order and generate the initial ID
            lucide.createIcons();
        };

        // Event listener for food cards (using event delegation)
        document.getElementById('food-items-container').addEventListener('click', (event) => {
            const card = event.target.closest('[data-item-id]');
            if (card) {
                handleAddToCart(card.dataset.itemId);
            }
        });

        // Event listener for cart buttons (using event delegation)
        document.getElementById('cart-items-container').addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (button) {
                const action = button.dataset.action;
                const itemId = button.dataset.id;
                if (action === 'add') {
                    handleAddToCart(itemId);
                } else if (action === 'remove') {
                    handleRemoveFromCart(itemId);
                }
            }
        });

        // Event listeners for payment and download buttons
        document.getElementById('cash-button').addEventListener('click', () => handlePayment('cash'));
        document.getElementById('online-button').addEventListener('click', () => handlePayment('online'));
        document.getElementById('qr-simulate-button').addEventListener('click', simulateOnlinePayment);
        document.getElementById('qr-close-button').addEventListener('click', closeQrModal);
        document.getElementById('download-report-button').addEventListener('click', handleDownloadReport);
        document.getElementById('next-order-button').addEventListener('click', startNewOrder);

        // Function to create Lucide icons dynamically
        const updateLucideIcons = () => {
            const iconElements = document.querySelectorAll('[data-lucide]');
            iconElements.forEach(el => {
                lucide.createIcons({
                    icons: lucide.icons,
                    attributes: {
                        'stroke-width': 2,
                        'size': 20,
                        'class': 'inline-block'
                    }
                });
            });
        };
    </script>

    <!-- Main App Layout -->
    <div class="w-full max-w-7xl flex flex-col sm:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-lg mb-6">
        <h1 class="text-3xl font-extrabold text-indigo-600">ANPURNA CANTEEN CRISP</h1>
        <div class="mt-4 sm:mt-0 text-sm text-gray-500">
            <span class="font-semibold">Order ID:</span> <span id="current-order-id">...</span>
        </div>
    </div>

    <div class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Food Items Section -->
        <div class="lg:col-span-2">
            <div id="food-items-container" class="grid grid-cols-3 md:grid-cols-3 gap-4">
                <!-- Food cards will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- Cart and Payment Section -->
        <div class="lg:col-span-1">
            <div class="sticky top-4 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 border-gray-200">Order Summary</h2>

                <ul id="cart-items-container" class="mb-4 space-y-3">
                    <!-- Cart items will be rendered here by JavaScript -->
                </ul>
                
                <p id="cart-empty-message" class="text-center text-gray-500 italic">Your cart is empty.</p>

                <div class="flex justify-between items-center text-2xl font-extrabold mt-6 pt-4 border-t border-gray-200">
                    <span>Total:</span>
                    <span id="total-amount">â‚¹0</span>
                </div>

                <div class="mt-6 space-y-4">
                    <button id="cash-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-colors disabled:opacity-50" disabled>Pay with Cash</button>
                    <button id="online-button" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-colors disabled:opacity-50" disabled>Pay Online</button>
                    <button id="next-order-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-colors">Next Order</button>
                </div>

                <div id="message-box">
                    <!-- Messages will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer and Report Download Button -->
    <div class="w-full max-w-7xl mt-6 p-4 bg-white rounded-2xl shadow-lg flex justify-between items-center">
        <div class="flex-1 text-sm text-gray-500">
            <p>Ready to serve!</p>
        </div>
        <button id="download-report-button" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-gray-300 transition-colors">
            <span data-lucide="download"></span>
            Download All Transactions as Excel
        </button>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-4">Scan to Pay</h3>
            <p class="text-lg mb-4">Total Amount: <span id="qr-total-amount" class="font-bold">â‚¹0</span></p>
            
            <div id="qr-image-container">
                <img src="https://ichef.bbci.co.uk/images/ic/1200x675/p0jsjg0j.jpg"/>
            </div>

            <div id="qr-success-message" class="flex flex-col items-center hidden">
                <svg data-lucide="check-circle" class="text-green-500 animate-pulse" width="80" height="80"></svg>
                <p class="text-2xl font-bold text-green-500 mt-4">Payment Successful!</p>
            </div>

            <div id="qr-payment-buttons" class="mt-4 space-y-4">
                <button id="qr-simulate-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-colors">
                    Simulate Payment Success
                </button>
            </div>
            
            <button id="qr-close-button" class="mt-4 text-gray-500 hover:text-gray-700 font-semibold transition-colors">
                Close
            </button>
        </div>
    </div>
</body>
</html>

